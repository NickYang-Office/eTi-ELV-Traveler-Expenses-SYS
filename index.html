<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廢車組人員差旅費用試算系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-group { margin-bottom: 1rem; }
        .input-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .input-field { width: 100%; border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem; font-size: 1rem; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #3b82f6; ring: 2px solid #3b82f6; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-outline { background-color: transparent; border: 1px solid #d1d5db; color: #4b5563; }
        .btn-outline:hover { background-color: #f3f4f6; }
        
        .day-header { background-color: #f0f9ff; border-bottom: 2px solid #3b82f6; padding: 1rem; border-radius: 0.75rem 0.75rem 0 0; display: flex; justify-content: space-between; align-items: center;}
        .day-body { padding: 1rem; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 0.75rem 0.75rem; background: white; }
        
        .grand-total-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1e3a8a; color: white; padding: 1rem; box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50; }
        
        .applicant-tag { display: inline-flex; align-items: center; background: #eff6ff; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; margin-right: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #bfdbfe; }
        .applicant-tag button { margin-left: 0.5rem; color: #93c5fd; }
        .applicant-tag button:hover { color: #1e40af; }

        .app-row { transition: background-color 0.2s; }
        .app-row:hover { background-color: #f9fafb; }
        
        /* Custom Select Style for cleaner table */
        .cost-select {
            background-color: #fff;
            border: 1px solid #d1d5db;
            color: #374151;
            font-size: 0.85rem;
            border-radius: 0.25rem;
            padding: 0.25rem 1.5rem 0.25rem 0.5rem; /* Extra right padding for arrow */
            outline: none;
            width: 100%;
            min-width: 130px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.2rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        .cost-select:focus { border-color: #3b82f6; }
    </style>
</head>
<body class="pb-32">

<div class="max-w-5xl mx-auto p-4">
    <!-- Header -->
    <div class="mb-6 text-center">
        <h1 class="text-2xl font-bold text-gray-800"><i class="fas fa-calculator text-blue-500 mr-2"></i>廢車組人員差旅費用試算系統(ver 0.1)</h1>
        <p class="text-gray-500 text-sm mt-1">智慧行程費用估算</p>
    </div>

    <!-- Global Settings Card -->
    <div class="card border-l-4 border-blue-500">
        <h2 class="text-lg font-bold mb-4 text-gray-700">1. 基本設定 (全行程適用)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Applicants Section -->
            <div class="col-span-1 md:col-span-2 bg-blue-50 p-4 rounded-lg border border-blue-100">
                <label class="input-label mb-2">申請人名單</label>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="newApplicantInput" class="input-field" placeholder="輸入姓名後按新增" onkeypress="handleEnter(event)">
                    <button onclick="addApplicant()" class="btn btn-primary whitespace-nowrap">新增</button>
                </div>
                <div id="applicantList" class="flex flex-wrap">
                    <!-- Tags will appear here -->
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">出發辦公室 (起點)</label>
                <select id="originOffice" class="input-field bg-yellow-50" onchange="recalculateAll()">
                    <option value="新北" selected>新北辦公室</option>
                    <option value="台中">台中辦公室</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">共乘分母人數 (計算用)</label>
                <input type="number" id="carpoolCount" class="input-field bg-yellow-50" value="1" min="1" onchange="recalculateAll()">
                <p class="text-xs text-gray-500 mt-1">*「平分」時，金額將除以此數字</p>
            </div>
        </div>
    </div>

    <!-- Days Container -->
    <div id="daysContainer" class="space-y-6">
        <!-- Day Cards will be injected here -->
    </div>

    <!-- Add Day Button -->
    <div class="mt-6 text-center">
        <button onclick="addDay()" class="btn btn-success text-lg px-6 py-3 shadow-lg transform hover:scale-105 transition-transform">
            <i class="fas fa-calendar-plus mr-2"></i> 新增日期
        </button>
    </div>

    <!-- Final Summary Breakdown -->
    <div class="card mt-8 border-l-4 border-indigo-500" id="finalSummaryCard">
        <h2 class="text-lg font-bold mb-4 text-gray-700">4. 費用總結</h2>
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-100 text-gray-600 text-sm border-b border-gray-200">
                    <th class="p-3">姓名</th>
                    <th class="p-3 text-right">差旅費總和</th>
                    <th class="p-3 text-right">文件寄送費</th>
                    <th class="p-3 text-right">應申報總額</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody">
                <!-- Rows populated by JS -->
            </tbody>
        </table>
    </div>

</div>

<!-- Grand Total Bar -->
<div class="grand-total-bar flex justify-between items-center">
    <div>
        <div class="text-sm opacity-80">本次申請總支出</div>
        <div class="text-xs opacity-60" id="totalApplicantsCount">0 位人員合計</div>
    </div>
    <div class="text-3xl font-bold" id="grandTotalDisplay">$0</div>
</div>

<!-- Vendor Data Template (Hidden) -->
<datalist id="vendorOptions">
    <!-- Populated by JS -->
</datalist>

<script>
    // --- 1. DATA DATABASE ---
    const vendorsDB = [
        {"name": "岏宬", "city": "宜蘭", "cost": 1300}, 
        {"name": "宏泰", "city": "宜蘭", "cost": 1300}, 
        {"name": "源益", "city": "宜蘭", "cost": 1300}, 
        {"name": "信捷", "city": "宜蘭", "cost": 1300}, 
        {"name": "銓鈐", "city": "基隆", "cost": 650}, 
        {"name": "萬新", "city": "基隆", "cost": 650}, 
        {"name": "順瀚七堵", "city": "基隆", "cost": 650}, 
        {"name": "原裕", "city": "台北", "cost": 250}, 
        {"name": "環泰", "city": "台北", "cost": 250}, 
        {"name": "正泰", "city": "台北", "cost": 250}, 
        {"name": "印北", "city": "台北", "cost": 250}, 
        {"name": "仲亮", "city": "新北", "cost": 300}, 
        {"name": "建新", "city": "新北", "cost": 300}, 
        {"name": "泳裕", "city": "新北", "cost": 300}, 
        {"name": "華春", "city": "新北", "cost": 300}, 
        {"name": "發輝", "city": "新北", "cost": 300}, 
        {"name": "穗成", "city": "新北", "cost": 300}, 
        {"name": "上元", "city": "新北", "cost": 300}, 
        {"name": "阿米哥", "city": "新北", "cost": 300}, 
        {"name": "盛祿", "city": "新北", "cost": 300}, 
        {"name": "金協連", "city": "新北", "cost": 300}, 
        {"name": "崇祐", "city": "新北", "cost": 300}, 
        {"name": "萬益", "city": "新北", "cost": 300}, 
        {"name": "大輝", "city": "新北", "cost": 300}, 
        {"name": "天機", "city": "新北", "cost": 300}, 
        {"name": "炬田", "city": "新北", "cost": 300}, 
        {"name": "金協億", "city": "新北", "cost": 300}, 
        {"name": "合全", "city": "新北", "cost": 300}, 
        {"name": "釧合", "city": "新北", "cost": 300}, 
        {"name": "俊陽伸", "city": "新北", "cost": 300}, 
        {"name": "家泰", "city": "桃園", "cost": 650}, 
        {"name": "新公鋼鐵", "city": "桃園", "cost": 650}, 
        {"name": "三億", "city": "桃園", "cost": 650}, 
        {"name": "大同", "city": "桃園", "cost": 650}, 
        {"name": "富源", "city": "桃園", "cost": 650}, 
        {"name": "展欣", "city": "桃園", "cost": 650}, 
        {"name": "達祐", "city": "桃園", "cost": 650}, 
        {"name": "裕清", "city": "桃園", "cost": 650}, 
        {"name": "昊駿", "city": "桃園", "cost": 650}, 
        {"name": "生光", "city": "桃園", "cost": 650}, 
        {"name": "瑞明", "city": "桃園觀音大園", "cost": 900}, 
        {"name": "北區實業", "city": "桃園", "cost": 650}, 
        {"name": "鑫茂", "city": "桃園", "cost": 650}, 
        {"name": "順發", "city": "桃園", "cost": 650}, 
        {"name": "新公環境", "city": "桃園", "cost": 650}, 
        {"name": "鴻岳", "city": "桃園觀音大園", "cost": 900}, 
        {"name": "力群", "city": "桃園觀音大園", "cost": 900}, 
        {"name": "灃利", "city": "桃園觀音大園", "cost": 900}, 
        {"name": "佑運", "city": "桃園", "cost": 650}, 
        {"name": "三權", "city": "桃園", "cost": 650}, 
        {"name": "長興", "city": "新竹", "cost": 1100}, 
        {"name": "宏田", "city": "新竹", "cost": 1100}, 
        {"name": "泰夌", "city": "新竹", "cost": 1100}, 
        {"name": "和昌", "city": "新竹", "cost": 1100}, 
        {"name": "旺亨", "city": "新竹", "cost": 1100}, 
        {"name": "植元", "city": "新竹", "cost": 1100}, 
        {"name": "聯華", "city": "新竹", "cost": 1100}, 
        {"name": "黃金城", "city": "苗栗", "cost": 950}, 
        {"name": "國軒", "city": "苗栗", "cost": 950}, 
        {"name": "金進", "city": "苗栗", "cost": 950}, 
        {"name": "禾盛", "city": "苗栗", "cost": 950}, 
        {"name": "佑順環保", "city": "苗栗", "cost": 950}, 
        {"name": "得意行", "city": "苗栗", "cost": 950}, 
        {"name": "佑順汽車", "city": "苗栗", "cost": 950}, 
        {"name": "中華行", "city": "台中", "cost": 350}, 
        {"name": "強鏡", "city": "台中", "cost": 350}, 
        {"name": "台一", "city": "台中", "cost": 350}, 
        {"name": "欣潔", "city": "台中", "cost": 350}, 
        {"name": "全一", "city": "台中", "cost": 350}, 
        {"name": "大安中古", "city": "台中大安", "cost": 600}, 
        {"name": "中鐵", "city": "台中", "cost": 350}, 
        {"name": "暐凱", "city": "台中太平", "cost": 400}, 
        {"name": "展誠", "city": "台中", "cost": 350}, 
        {"name": "益杰", "city": "台中", "cost": 350}, 
        {"name": "百福", "city": "台中", "cost": 350}, 
        {"name": "高宏", "city": "台中", "cost": 350}, 
        {"name": "宜信", "city": "台中太平", "cost": 400}, 
        {"name": "鑫永興", "city": "台中", "cost": 350}, 
        {"name": "高達", "city": "台中", "cost": 350}, 
        {"name": "鼎集", "city": "台中", "cost": 350}, 
        {"name": "豐盛", "city": "台中", "cost": 350}, 
        {"name": "偉豪", "city": "台中", "cost": 350}, 
        {"name": "嘉錩", "city": "台中", "cost": 350}, 
        {"name": "同宸", "city": "台中", "cost": 350}, 
        {"name": "大里金屬", "city": "台中", "cost": 350}, 
        {"name": "回玻", "city": "台中", "cost": 350}, 
        {"name": "祥悅", "city": "台中", "cost": 350}, 
        {"name": "翌鋐", "city": "台中", "cost": 350}, 
        {"name": "經智鴻", "city": "台中", "cost": 350}, 
        {"name": "星中", "city": "台中太平", "cost": 400}, 
        {"name": "和泰", "city": "台中", "cost": 350}, 
        {"name": "高盟", "city": "南投", "cost": 750}, 
        {"name": "南投環保", "city": "南投", "cost": 750}, 
        {"name": "信雄", "city": "南投竹山", "cost": 950}, 
        {"name": "洪佳", "city": "南投", "cost": 750},
        {"name": "追蹤查核-宜蘭", "city": "宜蘭", "cost": 1300},
        {"name": "追蹤查核-基隆", "city": "基隆", "cost": 650},
        {"name": "追蹤查核-台北", "city": "台北", "cost": 250},
        {"name": "追蹤查核-新北", "city": "新北", "cost": 300},
        {"name": "追蹤查核-桃園", "city": "桃園", "cost": 650},
        {"name": "追蹤查核-桃園觀音大園", "city": "桃園觀音大園", "cost": 900},
        {"name": "追蹤查核-新竹", "city": "新竹", "cost": 1100},
        {"name": "追蹤查核-苗栗", "city": "苗栗", "cost": 950},
        {"name": "追蹤查核-台中", "city": "台中", "cost": 350},
        {"name": "追蹤查核-台中大安", "city": "台中大安", "cost": 600},
        {"name": "追蹤查核-台中太平", "city": "台中太平", "cost": 400},
        {"name": "追蹤查核-南投", "city": "南投", "cost": 750},
        {"name": "追蹤查核-南投竹山", "city": "南投竹山", "cost": 950},
        {"name": "追蹤查核-彰化", "city": "彰化", "cost": 600}
    ];

    // Exclusion Groups
    const exclusionGroups = [["信捷", "宏泰", "岏宬"], ["阿米哥", "上元", "萬新"], ["正泰", "環泰"], ["建新", "大輝"], ["發輝", "炬田", "金協億", "金協連", "俊陽伸"], ["泳裕", "仲亮", "合全", "萬益", "崇祐"], ["永吉", "三權", "瑞明"], ["鴻岳", "力群", "順發"], ["天機", "盛祿"], ["新公環境", "新公鋼鐵"], ["和昌", "宏田"], ["回玻", "信全"], ["強鏡", "益杰", "高達"], ["大里", "展誠"], ["佑順環保", "禾盛"], ["佑運", "鑫茂"]];

    let applicants = [];

    // --- 2. INITIALIZATION ---
    window.onload = function() {
        const dataList = document.getElementById('vendorOptions');
        vendorsDB.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant'));
        vendorsDB.forEach(v => {
            let option = document.createElement('option');
            option.value = v.name;
            option.label = `${v.city} ($${v.cost})`;
            dataList.appendChild(option);
        });

        // Add default applicant
        addApplicant("申請人1");

        // Add first day by default
        addDay();
    };

    // --- 3. APPLICANT MANAGEMENT ---
    function handleEnter(e) {
        if (e.key === 'Enter') addApplicant();
    }

    function addApplicant(nameOverride) {
        const input = document.getElementById('newApplicantInput');
        const name = nameOverride || input.value.trim();
        
        if (name) {
            if (applicants.includes(name) && !nameOverride) {
                alert("此申請人已在名單中");
                return;
            }
            applicants.push(name);
            renderApplicants();
            input.value = '';
            recalculateAll();
        }
    }

    function removeApplicant(index) {
        if (applicants.length <= 1) {
            alert("至少需要一位申請人");
            return;
        }
        applicants.splice(index, 1);
        renderApplicants();
        recalculateAll();
    }

    function renderApplicants() {
        const container = document.getElementById('applicantList');
        container.innerHTML = '';
        applicants.forEach((app, index) => {
            const tag = document.createElement('div');
            tag.className = 'applicant-tag';
            tag.innerHTML = `<span><i class="fas fa-user mr-1"></i>${app}</span> <button onclick="removeApplicant(${index})"><i class="fas fa-times"></i></button>`;
            container.appendChild(tag);
        });
    }

    // --- 4. DAY & VENDOR UI ---
    function addDay() {
        const container = document.getElementById('daysContainer');
        const dayId = 'day-' + Date.now();
        
        // Default date logic
        let defaultDate = new Date().toISOString().split('T')[0];
        const dateInputs = document.querySelectorAll('input[type="date"]');
        if (dateInputs.length > 0) {
            const lastDateVal = dateInputs[dateInputs.length - 1].value;
            if (lastDateVal) {
                let d = new Date(lastDateVal);
                d.setDate(d.getDate() + 1);
                defaultDate = d.toISOString().split('T')[0];
            }
        }

        const dayHTML = `
            <div id="${dayId}" class="day-wrapper shadow-sm">
                <!-- Header -->
                <div class="day-header">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-calendar-day text-blue-600"></i>
                        <input type="date" class="input-field w-auto font-bold text-blue-900" value="${defaultDate}" onchange="recalculateAll()">
                    </div>
                    <button onclick="removeDay('${dayId}')" class="btn btn-outline btn-sm text-red-500 hover:text-white hover:bg-red-500 border-red-200" title="刪除此日"><i class="fas fa-times"></i></button>
                </div>
                
                <!-- Body -->
                <div class="day-body">
                    <!-- Vendor List -->
                    <div class="vendor-list-container space-y-2 mb-4" id="${dayId}-vendors">
                        <!-- Vendors go here -->
                    </div>
                    
                    <button onclick="addVendorRow('${dayId}')" class="btn btn-primary w-full py-2 mb-4 text-sm border-2 border-dashed border-blue-300 bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 shadow-none"><i class="fas fa-plus mr-1"></i> 新增廠商</button>
                    
                    <!-- Day Settings & Breakdown -->
                    <div class="bg-gray-50 p-4 rounded border border-gray-200">
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-500 mb-2">
                             <div>基礎費用 (原價): <span id="${dayId}-baseRaw" class="font-bold text-gray-700">0</span></div>
                             <div>有效加場數: <span id="${dayId}-extraCount">0</span></div>
                        </div>

                        <!-- Per Applicant Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-500 uppercase bg-gray-100">
                                    <tr>
                                        <th class="px-2 py-2">姓名</th>
                                        <th class="px-2 py-2 text-center">基礎費設定</th>
                                        <th class="px-2 py-2 text-center">加場費設定</th>
                                        <th class="px-2 py-2 text-right">當日小計</th>
                                    </tr>
                                </thead>
                                <tbody id="${dayId}-applicantTable">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', dayHTML);
        addVendorRow(dayId);
        addVendorRow(dayId);
        
        // Trigger recalculateAll to populate the new day's table immediately
        recalculateAll();
    }

    function removeDay(dayId) {
        if(confirm("確定要刪除這一整天的行程嗎？")) {
            document.getElementById(dayId).remove();
            recalculateAll();
        }
    }

    function addVendorRow(dayId) {
        const container = document.getElementById(dayId + '-vendors');
        const rowId = 'row-' + Date.now() + Math.random().toString(36).substr(2, 5);
        
        const rowHTML = `
            <div id="${rowId}" class="flex flex-col sm:flex-row gap-2 items-end sm:items-center p-2 rounded hover:bg-gray-50 border-b border-gray-100 last:border-0 relative group">
                <div class="w-8 text-gray-400 font-bold text-center text-xs index-label hidden sm:block">#</div>
                
                <div class="w-full sm:flex-1 relative">
                    <input type="text" list="vendorOptions" class="input-field vendor-input" placeholder="廠商名稱" onchange="onVendorChange('${rowId}', '${dayId}')" oninput="onVendorChange('${rowId}', '${dayId}')">
                    <span class="text-xs text-red-500 absolute right-2 top-2 hidden group-dupe-alert"><i class="fas fa-exclamation-circle"></i> 群組扣除</span>
                </div>

                <div class="flex gap-2 w-full sm:w-auto">
                    <input type="text" class="input-field bg-gray-100 text-gray-500 city-display text-sm w-1/2 sm:w-20" readonly tabindex="-1" placeholder="縣市">
                    <input type="number" class="input-field bg-gray-100 text-gray-500 cost-display text-sm w-1/2 sm:w-20" readonly tabindex="-1" placeholder="$">
                </div>

                <div class="w-full sm:w-20 text-center">
                     <span class="text-xs cross-city-badge px-2 py-1 rounded-full bg-gray-200 text-gray-400 block w-full text-center">-</span>
                </div>

                <button onclick="removeVendorRow('${rowId}')" class="text-gray-400 hover:text-red-500 px-2 transition-colors" tabindex="-1"><i class="fas fa-trash"></i></button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', rowHTML);
        updateIndexes(dayId);
    }

    function removeVendorRow(rowId) {
        const row = document.getElementById(rowId);
        const parent = row.parentElement; 
        row.remove();
        const dayId = parent.id.replace('-vendors', '');
        updateIndexes(dayId);
        recalculateAll();
    }

    function updateIndexes(dayId) {
        const rows = document.querySelectorAll(`#${dayId}-vendors > div`);
        rows.forEach((row, index) => {
            const label = row.querySelector('.index-label');
            if(label) label.innerText = index + 1;
        });
    }

    function onVendorChange(rowId, dayId) {
        const row = document.getElementById(rowId);
        const input = row.querySelector('.vendor-input');
        const cityDisplay = row.querySelector('.city-display');
        const costDisplay = row.querySelector('.cost-display');
        const badge = row.querySelector('.cross-city-badge');
        const origin = document.getElementById('originOffice').value;

        const val = input.value;
        const vendorData = vendorsDB.find(v => v.name === val);

        if (vendorData) {
            cityDisplay.value = vendorData.city;
            costDisplay.value = vendorData.cost;
            
            let isCross = true;
            if (origin === '新北') {
                if (vendorData.city.includes('新北') || vendorData.city.includes('台北')) isCross = false;
            } else if (origin === '台中') {
                if (vendorData.city.includes('台中')) isCross = false;
            }

            if (isCross) {
                badge.className = "text-xs cross-city-badge px-2 py-1 rounded-full bg-orange-100 text-orange-600 font-bold border border-orange-200 block w-full text-center";
                badge.innerText = "跨縣市";
            } else {
                badge.className = "text-xs cross-city-badge px-2 py-1 rounded-full bg-green-100 text-green-600 border border-green-200 block w-full text-center";
                badge.innerText = "本地";
            }

        } else {
            cityDisplay.value = '';
            costDisplay.value = '';
            badge.className = "text-xs cross-city-badge px-2 py-1 rounded-full bg-gray-200 text-gray-400 block w-full text-center";
            badge.innerText = "-";
        }
        recalculateAll();
    }

    // --- 5. CALCULATION LOGIC ---
    function recalculateAll() {
        const days = document.querySelectorAll('.day-wrapper');
        let applicantTotals = {}; // Map: Name -> Total
        
        // Init totals
        applicants.forEach(app => applicantTotals[app] = 0);

        days.forEach(day => {
            const dayResults = calculateDay(day.id); // Returns { name: amount }
            for (const [name, amount] of Object.entries(dayResults)) {
                if (applicantTotals[name] !== undefined) {
                    applicantTotals[name] += amount;
                }
            }
        });
        
        const docFee = 500;
        let grandTotal = 0;

        // Update Summary Table
        const tbody = document.getElementById('summaryTableBody');
        tbody.innerHTML = '';
        
        if (applicants.length === 0) {
             tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">請先新增申請人</td></tr>';
        } else {
            applicants.forEach(app => {
                const travelTotal = applicantTotals[app] || 0;
                const final = travelTotal + docFee;
                grandTotal += final;

                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 last:border-0";
                tr.innerHTML = `
                    <td class="p-3 font-medium text-gray-800"><i class="fas fa-user text-blue-400 mr-2"></i>${app}</td>
                    <td class="p-3 text-right text-gray-600">$${Math.round(travelTotal)}</td>
                    <td class="p-3 text-right text-gray-600">+$${docFee}</td>
                    <td class="p-3 text-right font-bold text-indigo-600">$${Math.round(final)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('totalApplicantsCount').innerText = `${applicants.length} 位人員合計 (含每人$500文件費)`;
        document.getElementById('grandTotalDisplay').innerText = "$" + Math.round(grandTotal).toLocaleString();
    }

    function calculateDay(dayId) {
        const origin = document.getElementById('originOffice').value;
        const carpoolCount = parseInt(document.getElementById('carpoolCount').value) || 1;
        const container = document.getElementById(dayId + '-vendors');
        const tableBody = document.getElementById(dayId + '-applicantTable');
        const dayContainer = document.getElementById(dayId);
        
        const inputs = container.querySelectorAll('.vendor-input');
        let selectedVendors = [];
        let maxCost = 0;
        let hasCrossCity = false;

        // 1. Gather Data
        inputs.forEach(input => {
            const row = input.closest('div[id^="row-"]');
            const vData = vendorsDB.find(v => v.name === input.value);
            
            input.classList.remove('text-red-500', 'font-bold');
            row.querySelector('.group-dupe-alert').classList.add('hidden');
            
            if (vData) {
                selectedVendors.push({data: vData, row: row});
                if (vData.cost > maxCost) maxCost = vData.cost;
                
                let isCross = true;
                if (origin === '新北') {
                    if (vData.city.includes('新北') || vData.city.includes('台北')) isCross = false;
                } else if (origin === '台中') {
                    if (vData.city.includes('台中')) isCross = false;
                }
                if (isCross) hasCrossCity = true;
                
                const badge = row.querySelector('.cross-city-badge');
                if (isCross) {
                    badge.className = "text-xs cross-city-badge px-2 py-1 rounded-full bg-orange-100 text-orange-600 font-bold border border-orange-200 block w-full text-center";
                    badge.innerText = "跨縣市";
                } else {
                    badge.className = "text-xs cross-city-badge px-2 py-1 rounded-full bg-green-100 text-green-600 border border-green-200 block w-full text-center";
                    badge.innerText = "本地";
                }
            }
        });

        // 2. Logic: Group Deductions
        if (selectedVendors.length === 0) maxCost = 0;
        const totalStops = selectedVendors.length;
        let deduction = 0;
        const vendorNames = selectedVendors.map(v => v.data.name);
        
        exclusionGroups.forEach(group => {
            let matchCount = 0;
            let matchedRows = [];
            group.forEach(gMember => {
                selectedVendors.forEach(sv => {
                    if(sv.data.name === gMember) matchedRows.push(sv);
                });
                if (vendorNames.includes(gMember)) matchCount++;
            });
            if (matchCount > 1) {
                deduction += (matchCount - 1);
                matchedRows.forEach(sv => {
                     sv.row.querySelector('.vendor-input').classList.add('text-red-500', 'font-bold');
                     sv.row.querySelector('.group-dupe-alert').classList.remove('hidden');
                 });
            }
        });

        // 3. Calc Fees
        let effectiveStops = 0;
        if (totalStops > 0) {
            effectiveStops = Math.max(0, totalStops - 1 - deduction);
        }
        const extraFeeTotal = effectiveStops * 100;

        // Display Base Raw Info
        document.getElementById(dayId + '-baseRaw').innerText = `$${maxCost}`;
        document.getElementById(dayId + '-extraCount').innerText = effectiveStops;

        // 4. Render Applicant Rows & Calculate Per Person
        let dayResult = {}; // name -> total

        // First clean up deleted applicants from DOM
        Array.from(tableBody.children).forEach(row => {
            const name = row.getAttribute('data-name');
            if (!applicants.includes(name)) {
                row.remove();
            }
        });

        applicants.forEach(app => {
            let row = tableBody.querySelector(`tr[data-name="${app}"]`);
            if (!row) {
                // Determine defaults by looking at previous day
                let defaultBase = 'split';
                let defaultExtra = 'full';
                
                // Try to find previous day
                const prevDay = dayContainer.previousElementSibling;
                if (prevDay && prevDay.classList.contains('day-wrapper')) {
                     const prevTable = prevDay.querySelector(`#${prevDay.id}-applicantTable`);
                     const prevRow = prevTable ? prevTable.querySelector(`tr[data-name="${app}"]`) : null;
                     if (prevRow) {
                         defaultBase = prevRow.querySelector('.base-mode-select').value;
                         defaultExtra = prevRow.querySelector('.extra-mode-select').value;
                     }
                }

                row = document.createElement('tr');
                row.setAttribute('data-name', app);
                row.className = "border-b border-gray-100 app-row";
                row.innerHTML = `
                    <td class="px-2 py-2 font-medium text-gray-700">${app}</td>
                    <td class="px-2 py-2 text-center">
                        <select class="base-mode-select cost-select" onchange="recalculateAll()">
                            <option value="full" ${defaultBase === 'full' ? 'selected' : ''}>全額</option>
                            <option value="split" ${defaultBase === 'split' ? 'selected' : ''}>平分</option>
                            <option value="none" ${defaultBase === 'none' ? 'selected' : ''}>不領取</option>
                        </select>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <select class="extra-mode-select cost-select" onchange="recalculateAll()">
                            <option value="full" ${defaultExtra === 'full' ? 'selected' : ''}>全額</option>
                            <option value="split" ${defaultExtra === 'split' ? 'selected' : ''}>平分</option>
                            <option value="none" ${defaultExtra === 'none' ? 'selected' : ''}>不領取</option>
                        </select>
                    </td>
                    <td class="px-2 py-2 text-right font-bold text-indigo-600 total-cell"></td>
                `;
                tableBody.appendChild(row);
            }
            
            const baseSelect = row.querySelector('.base-mode-select');
            const extraSelect = row.querySelector('.extra-mode-select');

            // Update Base Options Text (Dynamic amounts)
            baseSelect.options[0].text = `全額 (+$${maxCost})`;
            baseSelect.options[1].text = `平分 (+$${Math.round(maxCost/carpoolCount)})`;
            baseSelect.options[2].text = `不領取`;

            // Update Extra Options Text (Dynamic amounts)
            extraSelect.options[0].text = `全額 (+$${extraFeeTotal})`;
            extraSelect.options[1].text = `平分 (+$${Math.round(extraFeeTotal/carpoolCount)})`;
            extraSelect.options[2].text = `不領取`;
            
            // Auto-correct Split to Full if Local (and not explicitly set to 'none' by user)
            // Note: If user set to 'none', we respect that. If 'split', we force 'full'.
            if (!hasCrossCity) {
                if (baseSelect.value === 'split') baseSelect.value = 'full';
                if (extraSelect.value === 'split') extraSelect.value = 'full';
            }

            // Calculate Base
            let myBase = 0;
            const baseMode = baseSelect.value;
            if (baseMode === 'full') myBase = maxCost;
            else if (baseMode === 'split') myBase = maxCost / carpoolCount;

            // Calculate Extra
            let myExtra = 0;
            const extraMode = extraSelect.value;
            if (extraMode === 'full') myExtra = extraFeeTotal;
            else if (extraMode === 'split') myExtra = extraFeeTotal / carpoolCount;
            
            const myTotal = myBase + myExtra;
            dayResult[app] = myTotal;

            // Update Total Cell
            row.querySelector('.total-cell').innerText = `$${Math.round(myTotal)}`;
        });

        return dayResult;
    }
</script>

</body>

</html>

